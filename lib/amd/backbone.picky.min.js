// Backbone.Picky, v0.2.0
// Copyright (c)2014 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
// http://github.com/derickbailey/backbone.picky

!function(a,b){if("object"==typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(c,d)}else"function"==typeof define&&define.amd&&define(["underscore","backbone"],b)}(this,function(a,b){"option strict";return b.Picky=function(a,b){function c(a,b){g(a,b),a.selected&&b.select(a,{_silentReselect:!0})}function d(a,c,d){a._pickyCollections&&(a._pickyCollections=b.without(a._pickyCollections,c._pickyCid)),a.selected&&(a._pickyCollections&&0===a._pickyCollections.length?c.deselect(a,d):c.deselect(a,b.extend({},d,{_skipModelCall:!0})))}function e(a,c){var e,f,g=b.find(c.previousModels,function(a){return a.selected});g&&d(g,a,{_silentLocally:!0}),e=a.filter(function(a){return a.selected}),f=b.initial(e),f.length&&b.each(f,function(a){a.deselect()}),e.length&&a.select(b.last(e),{silent:!0})}function f(a,c){var e,f=b.filter(c.previousModels,function(a){return a.selected});f&&b.each(f,function(b){d(b,a,{_silentLocally:!0})}),e=a.filter(function(a){return a.selected}),e.length&&b.each(e,function(b){a.select(b,{silent:!0})})}function g(a,b){a._pickyCollections||(a._pickyCollections=[]),a._pickyCollections.push(b._pickyCid)}function h(a){a.each(function(b){d(b,a,{_silentLocally:!0})})}function i(a){return b.omit(a,"_silentLocally","_silentReselect","_skipModelCall","_processedBy")}function j(a){function c(a,b){d[b]=a}var d=[];return b.each(a,c),d}function k(a){function c(a,b,c){return c.toUpperCase()}function d(a){return"ed"===a.slice(-2)?a=a.slice(0,-2):(":one"===a.slice(-4)||":any"===a.slice(-4))&&(a=a.slice(0,-4)),a}var e=a.trigger,f=/(^|:)(\w)/gi;return function(a){var g=d(a),h="on"+g.replace(f,c),i=this[h];return b.isFunction(i)&&i.apply(this,b.tail(arguments)),e.apply(this,arguments),this}}var l={};l.SingleSelect=function(a,f){this._pickyCid=b.uniqueId("singleSelect"),this.collection=a,this.trigger=k(a),arguments.length>1&&(b.each(f||[],function(a){g(a,this),a.selected&&(this.selected=a)},this),this.collection.listenTo(this.collection,"_selected",this.select),this.collection.listenTo(this.collection,"_deselected",this.deselect),this.collection.listenTo(this.collection,"reset",e),this.collection.listenTo(this.collection,"add",c),this.collection.listenTo(this.collection,"remove",d),this._modelSharingEnabled=!0)},b.extend(l.SingleSelect.prototype,{select:function(a,c){var d=a&&this.selected===a?a:void 0;c||(c={}),c._processedBy||(c._processedBy=[]),c._processedBy[this._pickyCid]||(d||(this.deselect(void 0,b.omit(c,"_silentLocally")),this.selected=a),c._processedBy[this._pickyCid]=this,c._processedBy[this.selected.cid]||this.selected.select(b.omit(c,"_silentLocally")),c.silent||c._silentLocally||(d?c._silentReselect||this.trigger("reselect:one",a,this,i(c)):this.trigger("select:one",a,this,i(c))))},deselect:function(a,c){c||(c={}),this.selected&&(a=a||this.selected,this.selected===a&&(delete this.selected,c._skipModelCall||a.deselect(b.omit(c,"_silentLocally")),c.silent||c._silentLocally||this.trigger("deselect:one",a,this,i(c))))},close:function(){h(this),this.stopListening()}}),l.MultiSelect=function(a,e){this._pickyCid=b.uniqueId("multiSelect"),this.collection=a,this.selected={},this.trigger=k(a),arguments.length>1&&(b.each(e||[],function(a){g(a,this),a.selected&&(this.selected[a.cid]=a)},this),this.collection.listenTo(this.collection,"_selected",this.select),this.collection.listenTo(this.collection,"_deselected",this.deselect),this.collection.listenTo(this.collection,"reset",f),this.collection.listenTo(this.collection,"add",c),this.collection.listenTo(this.collection,"remove",d),this._modelSharingEnabled=!0)},b.extend(l.MultiSelect.prototype,{select:function(a,c){var d=j(this.selected),e=this.selected[a.cid]?[a]:[];c||(c={}),c._processedBy||(c._processedBy=[]),e.length&&c._processedBy[this._pickyCid]||(e.length||(this.selected[a.cid]=a,this.selectedLength=b.size(this.selected)),c._processedBy[this._pickyCid]=this,c._processedBy[a.cid]||a.select(b.omit(c,"_silentLocally")),m(this,d,c,e))},deselect:function(a,c){var d=j(this.selected);c||(c={}),this.selected[a.cid]&&(delete this.selected[a.cid],this.selectedLength=b.size(this.selected),c._skipModelCall||a.deselect(b.omit(c,"_silentLocally")),m(this,d,c))},selectAll:function(a){var c=j(this.selected),d=[];a||(a={}),a._processedBy||(a._processedBy=[]),this.selectedLength=0,this.each(function(c){this.selectedLength++,this.selected[c.cid]&&d.push(c),this.select(c,b.extend({},a,{_silentLocally:!0}))},this),a._processedBy[this._pickyCid]=this,m(this,c,a,d)},deselectAll:function(a){var c;0!==this.selectedLength&&(c=j(this.selected),this.each(function(c){c.selected&&this.selectedLength--,this.deselect(c,b.extend({},a,{_silentLocally:!0}))},this),this.selectedLength=0,m(this,c,a))},selectNone:function(a){this.deselectAll(a)},toggleSelectAll:function(a){this.selectedLength===this.length?this.deselectAll(a):this.selectAll(a)},close:function(){h(this),this.stopListening()}}),l.Selectable=function(a){this.model=a,this.trigger=k(a)},b.extend(l.Selectable.prototype,{select:function(a){var c=this.selected;a||(a={}),a._processedBy||(a._processedBy=[]),a._processedBy[this.cid]||(this.selected=!0,a._processedBy[this.cid]=this,this._pickyCollections?this.trigger("_selected",this,b.omit(a,"_silentLocally")):this.collection&&(a._processedBy[this.collection._pickyCid]||this.collection.select(this,b.omit(a,"_silentLocally"))),a.silent||a._silentLocally||(c?a._silentReselect||this.trigger("reselected",this,i(a)):this.trigger("selected",this,i(a))))},deselect:function(a){a||(a={}),this.selected&&(this.selected=!1,this._pickyCollections?this.trigger("_deselected",this,b.omit(a,"_silentLocally")):this.collection&&this.collection.deselect(this,b.omit(a,"_silentLocally")),a.silent||a._silentLocally||this.trigger("deselected",this,i(a)))},toggleSelected:function(a){this.selected?this.deselect(a):this.select(a)}}),l.Selectable.applyTo=function(c){var d=new a.Picky.Selectable(c);b.extend(c,d)},l.SingleSelect.applyTo=function(c,d){var e;e=arguments.length<2?new a.Picky.SingleSelect(c):new a.Picky.SingleSelect(c,d),b.extend(c,e)},l.MultiSelect.applyTo=function(c,d){var e;e=arguments.length<2?new a.Picky.MultiSelect(c):new a.Picky.MultiSelect(c,d),b.extend(c,e)};var m=function(a,c,d,e){function f(a,c,d){function e(a){return c.get(a)||d[a]}return b.map(a,e)}if(d||(d={}),!d.silent&&!d._silentLocally){var g,h=a.selectedLength,j=a.length,k=b.keys(c),l=b.keys(a.selected),m=b.difference(l,k),n=b.difference(k,l),o=h===k.length&&0===m.length&&0===n.length;if(e&&e.length&&!d._silentReselect&&a.trigger("reselect:any",e,a,i(d)),!o)return g={selected:f(m,a,c),deselected:f(n,a,c)},h===j?void a.trigger("select:all",g,a,i(d)):0===h?void a.trigger("select:none",g,a,i(d)):h>0&&j>h?void a.trigger("select:some",g,a,i(d)):void 0}};return l}(b,a),b.Picky});