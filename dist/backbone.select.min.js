// Backbone.Select, v1.5.4
// Copyright (c) 2014-2016 Michael Heim, Zeilenwechsel.de
//           (c) 2013 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
// http://github.com/hashchange/backbone.select


!function(Backbone,_){"use strict";function a(a,b,c,d){function e(a,b,c){function d(a){return b.get(a)||c[a]}return _.map(a,d)}if(!c.silent&&!c._silentLocally){var f,g=m(c,a),h=t(a,g),i=a.length,j=_.keys(b),k=_.keys(a[g]),n=_.difference(k,j),o=_.difference(j,k),p=h===j.length&&0===n.length&&0===o.length;if(d&&d.length&&!c._silentReselect&&z("reselect:any",g,[d,a,l(c,g,a)],a,c),!p)return f={selected:e(n,a,b),deselected:e(o,a,b)},h===i?void z("select:all",g,[f,a,l(c,g,a)],a,c):0===h?void z("select:none",g,[f,a,l(c,g,a)],a,c):h>0&&i>h?void z("select:some",g,[f,a,l(c,g,a)],a,c):void 0}}function b(a,b){g(a,b),w(a,function(c){"Backbone.Select.Many"===b._pickyType&&n(c,b),a[c]&&b.select(a,{_silentReselect:!0,_externalEvent:"add",label:c})})}function c(a,b,c){d(a,b,_.extend({},c,{_externalEvent:"remove"}))}function d(a,b,c){a._pickyCollections&&(a._pickyCollections=_.without(a._pickyCollections,b._pickyCid)),v(b,function(d){var e;a[d]&&(e=a._pickyCollections&&0===a._pickyCollections.length?_.extend({},c,{label:d}):_.extend({},c,{label:d,_skipModelCall:!0}),b.deselect(a,e))})}function e(a,b){var c,e,f={};v(a,function(a){var c=_.find(b.previousModels,function(b){return b[a]});c&&(f[c.cid]=c)}),_.each(f,function(b){d(b,a,{_silentLocally:!0})}),_.each(b.previousModels,function(b){b._pickyCollections&&(b._pickyCollections=_.without(b._pickyCollections,a._pickyCid))}),a.each(function(b){g(b,a),o(b,a)}),v(a,function(b){c=a.filter(function(a){return a[b]}),e=_.initial(c),e.length&&_.each(e,function(a){a.deselect({label:b})}),c.length&&a.select(_.last(c),{silent:!0,label:b})})}function f(a,b){var c,e=_.filter(b.previousModels,function(b){return p(b,a)});e&&_.each(e,function(b){d(b,a,{_silentLocally:!0})}),_.each(b.previousModels,function(b){b._pickyCollections&&(b._pickyCollections=_.without(b._pickyCollections,a._pickyCid))}),a.each(function(b){g(b,a),o(b,a)}),v(a,function(b){c=a.filter(function(a){return a[b]}),c.length&&_.each(c,function(c){a.select(c,{silent:!0,label:b})})})}function g(a,b){a._pickyCollections||(a._pickyCollections=[]),a._pickyCollections.push(b._pickyCid)}function h(a){a.each(function(b){d(b,a,{_silentLocally:!0})})}function i(a){return _.omit(a,M)}function j(a,b){var c=M;return b&&(_.isString(b)&&(b=[b]),c=_.without.apply(void 0,[M].concat(b))),_.omit(a,c)}function k(a){return _.omit(a,N)}function l(a,b){var c=k(a);return _.extend(c,{label:b}),c}function m(a,b){return a.label||(a.label=b._pickyDefaultLabel),n(a.label,b),a.label}function n(a,b){if(a&&!b._pickyLabels[a]&&!r(a,b)){if(-1!==_.indexOf(J,a))throw new Error('Illegal label name "'+a+'", is in conflict with an existing Backbone or Backbone.Select property or method');b._pickyLabels[a]=!0,"Backbone.Select.Many"===b._pickyType&&(b[a]={},u(0,b,a))}}function o(a,b){w(a,function(a){n(a,b)})}function p(a,b){var c=!1;return v(b,function(b){c||(c=a[b])}),c}function q(a,b){if(a||(a=[]),_.isString(a)&&(a=[a]),!_.isArray(a))throw new Error("ignoreLabel option: illegal value. Expected a string or an array of strings but got the value "+a);if(_.contains(a,b._pickyDefaultLabel))throw new Error("ignoreLabel option: illegal value. Can't ignore the default label, \""+b._pickyDefaultLabel+'", of a collection (_pickyCid: '+b._pickyCid+")");b._pickyIgnoredLabels=a}function r(a,b){return a&&b._pickyIgnoredLabels?_.contains(b._pickyIgnoredLabels,a):!1}function s(a){return a+"Length"}function t(a,b){return a[s(b)]}function u(a,b,c){b[s(c)]=a}function v(a,b){x(a,b)}function w(a,b){x(a,b)}function x(a,b){var c=_.keys(a._pickyLabels);_.each(c,function(d,e){b(d,a,e,c)})}function y(a){return a||(a={}),a._processedBy||(a._processedBy={}),a._eventQueue||(a._eventQueue=[]),a}function z(a,b,c,d,e){B(e,d,[a].concat(c)),B(e,d,[a+":"+b].concat(c))}function A(a){return a._eventQueueAppendOnly||a._eventQueue}function B(a,b,c){var d=A(a);d.push({context:b,triggerArgs:c})}function C(a){var b,c;if(a._eventQueue.length&&(b=_.every(a._processedBy,function(a){return a.done})))for(D(a._eventQueue);a._eventQueue.length;)c=a._eventQueue.pop(),c.context.trigger.apply(c.context,c.triggerArgs)}function D(a){var b={};_.each(a,function(a,c){var d,e,f,g,h,i=a.context,j=a.triggerArgs[0];"Backbone.Select.Many"===i._pickyType&&-1===j.indexOf("reselect:any")&&(d=j.replace(/^select:(all|some|none):?/,""),e=i._pickyCid+"-ns-"+d,f=b[e],f||(f=b[e]={context:i,label:d,indexes:[],merged:{selected:[],deselected:[],options:{}}}),f.indexes.push(c),g=a.triggerArgs[1],h=a.triggerArgs[3],f.merged.selected=f.merged.selected.concat(g.selected),f.merged.deselected=f.merged.deselected.concat(g.deselected),_.extend(f.merged.options,h))}),b=_.filter(b,function(a){return a.indexes.length>1});var c=_.flatten(_.pluck(b,"indexes"));c.sort(function(a,b){return a-b}),_.each(c,function(b,c){a.splice(b-c,1)}),_.each(b,function(b){a.push({context:b.context,triggerArgs:[b.label?"select:some:"+b.label:"select:some",{selected:b.merged.selected,deselected:b.merged.deselected},b.context,b.merged.options]})})}function E(a,b){b.select=function(){var c=b.select;return function(d){return d instanceof Backbone.Model?c.apply(b,arguments):a.apply(b,arguments)}}()}function F(a){a.trigger=function(){var b=a.trigger;return function(a,c){if(G(a)){var d=I(a),e="on"+d.replace(/(^|:)(\w)/gi,H),f=this[e];_.isFunction(f)&&f.apply(this,_.tail(arguments))}return b.apply(this,arguments),this}}()}function G(a){return/^([rd]e)?select(ed)?($|:)/.test(a)}function H(a,b,c){return c.toUpperCase()}function I(a){return"ed"===a.slice(-2)?a=a.slice(0,-2):":one"!==a.slice(-4)&&":any"!==a.slice(-4)||(a=a.slice(0,-4)),a}var J=[],K={SelectOne:{_pickyType:"Backbone.Select.One",select:function(a,b){var c,d,e,f;return b=y(b),b._processedBy[this._pickyCid]?this:(c=m(b,this),r(c,this)?this:(d=a&&this[c]===a?a:void 0,d||(f=_.extend(_.omit(b,"_silentLocally","_processedBy","_eventQueue"),{_eventQueueAppendOnly:A(b)}),this.deselect(void 0,f),this[c]=a),b._processedBy[this._pickyCid]={done:!1},b._processedBy[this[c].cid]||this[c].select(i(b)),b.silent||b._silentLocally||(e=l(b,c,this),d?b._silentReselect||z("reselect:one",c,[a,this,e],this,b):z("select:one",c,[a,this,e],this,b)),b._processedBy[this._pickyCid].done=!0,C(b),this))},deselect:function(a,b){var c;return b=y(b),b._processedBy[this._pickyCid]?this:(c=m(b,this),r(c,this)||!this[c]?this:b._messageOnly?this:(a=a||this[c],this[c]!==a?this:(b._processedBy[this._pickyCid]={done:!1},delete this[c],b._skipModelCall||a.deselect(i(b)),b.silent||b._silentLocally||z("deselect:one",c,[a,this,l(b,c,this)],this,b),b._processedBy[this._pickyCid].done=!0,C(b),this)))},close:function(){return h(this),this.stopListening(),this}},SelectMany:{_pickyType:"Backbone.Select.Many",select:function(b,c){var d,e,f,g;return c=y(c),d=m(c,this),r(d,this)?this:(e=_.clone(this[d]),f=this[d][b.cid]?[b]:[],f.length&&c._processedBy[this._pickyCid]?this:(c.exclusive&&(g=_.extend(_.omit(c,"_eventQueue","exclusive"),{_eventQueueAppendOnly:A(c),_silentLocally:!0}),this.each(function(a){a!==b&&this.deselect(a,_.omit(g,"_processedBy"))},this)),f.length||(this[d][b.cid]=b,u(_.size(this[d]),this,d)),c._processedBy[this._pickyCid]={done:!1},c._processedBy[b.cid]||b.select(i(c)),a(this,e,c,f),c._processedBy[this._pickyCid].done=!0,C(c),this))},deselect:function(b,c){var d,e;return b?(c=y(c),c._processedBy[this._pickyCid]?this:(d=m(c,this),r(d,this)?this:c._messageOnly?this:(e=_.clone(this[d]),this[d][b.cid]?(c._processedBy[this._pickyCid]={done:!1},delete this[d][b.cid],u(_.size(this[d]),this,d),c._skipModelCall||b.deselect(i(c)),a(this,e,c),c._processedBy[this._pickyCid].done=!0,C(c),this):this))):this.deselectAll(c)},selectAll:function(b){var c,d,e,f=[];return b=y(b),c=m(b,this),r(c,this)?this:(d=_.clone(this[c]),e=_.extend(_.omit(b,"_eventQueue","exclusive"),{_eventQueueAppendOnly:A(b),_silentLocally:!0}),this.each(function(a){this[c][a.cid]&&f.push(a),this.select(a,_.omit(e,"_processedBy"))},this),u(_.size(this[c]),this,c),a(this,d,b,f),b._processedBy[this._pickyCid]?b._processedBy[this._pickyCid].done=!0:b._processedBy[this._pickyCid]={done:!0},C(b),this)},invertSelection:function(b){var c,d,e;return b=y(b),c=m(b,this),r(c,this)?this:(d=_.clone(this[c]),e=_.extend(_.omit(b,"_eventQueue","exclusive"),{_eventQueueAppendOnly:A(b),_silentLocally:!0}),this.each(function(a){this[c][a.cid]?this.deselect(a,_.omit(e,"_processedBy")):this.select(a,_.omit(e,"_processedBy"))},this),u(_.size(this[c]),this,c),a(this,d,b),b._processedBy[this._pickyCid]?b._processedBy[this._pickyCid].done=!0:b._processedBy[this._pickyCid]={done:!0},C(b),this)},deselectAll:function(b){var c,d,e;return b=y(b),d=m(b,this),r(d,this)?this:0===t(this,d)?this:(c=_.clone(this[d]),e=_.extend(_.omit(b,"_eventQueue"),{_eventQueueAppendOnly:A(b),_silentLocally:!0}),this.each(function(a){this.deselect(a,_.omit(e,"_processedBy"))},this),u(0,this,d),a(this,c,b),b._processedBy[this._pickyCid]?b._processedBy[this._pickyCid].done=!0:b._processedBy[this._pickyCid]={done:!0},C(b),this)},selectNone:function(a){return this.deselectAll(a)},toggleSelectAll:function(a){var b;return a||(a={}),b=m(a,this),r(b,this)?this:(t(this,b)===this.length?this.deselectAll(a):this.selectAll(a),this)},close:function(){return h(this),this.stopListening(),this}},SelectMe:{_pickyType:"Backbone.Select.Me",select:function(a){var b,c,d;return a=y(a),a._processedBy[this.cid]?this:(a._processedBy[this.cid]={done:!1},b=m(a,this),c=this[b],this[b]=!0,this._pickyCollections?this.trigger("_selected",this,j(a,"exclusive")):this.collection&&(a._processedBy[this.collection._pickyCid]||this.collection.select(this,j(a,"exclusive"))),a.silent||a._silentLocally||(d=l(a,b,this),c?a._silentReselect||z("reselected",b,[this,d],this,a):z("selected",b,[this,d],this,a)),a._processedBy[this.cid].done=!0,C(a),this)},deselect:function(a){var b,c;return a=y(a),a._processedBy[this.cid]?this:(b=m(a,this),c=!this[b],a._processedBy[this.cid]={done:c},this[b]=!1,this._pickyCollections?(c&&(a=_.extend(a,{_messageOnly:!0})),this.trigger("_deselected",this,i(a))):this.collection&&(c&&(a=_.extend(a,{_messageOnly:!0})),this.collection.deselect(this,i(a))),c?this:(a.silent||a._silentLocally||z("deselected",b,[this,l(a,b,this)],this,a),a._processedBy[this.cid].done=!0,C(a),this))},toggleSelected:function(a){var b;return a||(a={}),b=m(a,this),this[b]?this.deselect(a):this.select(a),this}}},L={Me:{applyTo:function(a,b){if(!_.isObject(a))throw new Error("The host object is undefined or not an object.");_.extend(a,K.SelectMe),a._pickyLabels={},a._pickyDefaultLabel=b&&b.defaultLabel||"selected",n(a._pickyDefaultLabel,a),F(a)}},One:{applyTo:function(a,d,f){var h;if(!_.isObject(a))throw new Error("The host object is undefined or not an object.");if(arguments.length<2)throw new Error("The `models` parameter has not been passed to Select.One.applyTo. Its value can be undefined if no models are passed in during instantiation, but even so, it must be provided.");if(!(_.isArray(d)||_.isUndefined(d)||_.isNull(d)))throw new Error("The `models` parameter is not of the correct type. It must be either an array of models, or be undefined. (Null is acceptable, too).");h=a.select,_.extend(a,K.SelectOne),a._pickyCid=_.uniqueId("singleSelect"),a._pickyLabels={},a._pickyDefaultLabel=f&&f.defaultLabel||"selected",q(f&&f.ignoreLabel,a),n(a._pickyDefaultLabel,a),F(a),E(h,a),f&&f.enableModelSharing&&(_.each(d||[],function(b){g(b,a),w(b,function(c){n(c,a),b[c]&&!r(c,a)&&(a[c]&&a[c].deselect({label:c}),a[c]=b)})}),a.listenTo(a,"_selected",a.select),a.listenTo(a,"_deselected",a.deselect),a.listenTo(a,"reset",e),a.listenTo(a,"add",b),a.listenTo(a,"remove",c),a._modelSharingEnabled=!0)}},Many:{applyTo:function(a,d,e){var h,i=e&&e.enableModelSharing;if(!_.isObject(a))throw new Error("The host object is undefined or not an object.");if(arguments.length<2)throw new Error("The `models` parameter has not been passed to Select.One.applyTo. Its value can be undefined if no models are passed in during instantiation, but even so, it must be provided.");if(!(_.isArray(d)||_.isUndefined(d)||_.isNull(d)))throw new Error("The `models` parameter is not of the correct type. It must be either an array of models, or be undefined. (Null is acceptable, too).");h=a.select,_.extend(a,K.SelectMany),a._pickyCid=_.uniqueId("multiSelect"),a._pickyLabels={},a._pickyDefaultLabel=e&&e.defaultLabel||"selected",q(e&&e.ignoreLabel,a),n(a._pickyDefaultLabel,a),F(a),E(h,a),i?(_.each(d||[],function(b){g(b,a),w(b,function(c){n(c,a),b[c]&&!r(c,a)&&(a[c][b.cid]=b)})}),a.listenTo(a,"_selected",a.select),a.listenTo(a,"_deselected",a.deselect),a.listenTo(a,"reset",f),a.listenTo(a,"add",b),a.listenTo(a,"remove",c),a._modelSharingEnabled=!0):d&&d[0]&&n(d[0]._pickyDefaultLabel,a)}}},M=["_silentLocally","_externalEvent","exclusive"],N=["_messageOnly","_silentLocally","_silentReselect","_skipModelCall","_processedBy","_eventQueue","_eventQueueAppendOnly"];Backbone.Select=L,function(){var a,b=[],c=[],d=[],e=Backbone.Model.extend({initialize:function(){Backbone.Select.Me.applyTo(this)}}),f=Backbone.Collection.extend({initialize:function(a){Backbone.Select.One.applyTo(this,a)}}),g=Backbone.Collection.extend({initialize:function(a){Backbone.Select.Many.applyTo(this,a)}}),h=new e,i=new f,j=new g;if(_.allKeys)b=_.allKeys(h),c=_.allKeys(i),d=_.allKeys(j);else{for(a in h)b.push(a);for(a in i)c.push(a);for(a in j)d.push(a)}J=_.without(_.union(b,c,d),"selected","selectedLength")}()}(Backbone,_);
//# sourceMappingURL=backbone.select.min.js.map